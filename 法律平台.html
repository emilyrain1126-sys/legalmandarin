<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>法律華語學習助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #f8fafc;
            color: #1e293b;
            font-family: "Source Sans Pro", "Noto Sans TC", sans-serif;
            -webkit-font-smoothing: antialiased;
            overflow-y: auto; 
            min-height: 100vh;
        }

        /* 側邊欄設計 */
        .sidebar {
            background-color: #f1f5f9;
            border-right: 1px solid #e2e8f0;
            width: 22%; 
            min-width: 280px;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            padding: 1.5rem 1.25rem;
            z-index: 100;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .sidebar::-webkit-scrollbar { width: 4px; }
        .sidebar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* 主區域佈局 */
        .main-content { 
            margin-left: clamp(280px, 22%, 340px); 
            padding: 0 2.5rem 3rem 2.5rem; 
            max-width: 1400px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* 置頂 Header */
        .sticky-header {
            position: sticky;
            top: 0;
            background-color: #f8fafc;
            padding: 1.25rem 0;
            z-index: 50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sticky-header.scrolled {
            border-bottom: 2px solid #e2e8f0;
            background-color: rgba(248, 250, 252, 0.95);
            backdrop-filter: blur(10px);
        }

        @media (max-width: 767px) {
            .sidebar { width: 100%; position: sticky; top: 0; height: auto; border-bottom: 2px solid #e2e8f0; }
            .main-content { margin-left: 0; padding: 1rem; }
            .sticky-header { position: relative; top: 0; }
        }
        
        .sub-title { 
            font-size: 1.4rem; 
            font-weight: 900; 
            color: #0f172a;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }

        .intro-quote {
            background-color: #eff6ff;
            color: #1d4ed8;
            padding: 1.25rem 1.5rem;
            border-radius: 1rem;
            font-size: 1.4rem;
            font-weight: 900;
            margin-bottom: 1.5rem;
            border-left: 8px solid #3b82f6;
            line-height: 1.4;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.1);
        }

        .content-text { 
            font-size: 1.15rem; 
            font-weight: 800; 
            line-height: 1.8; 
            white-space: pre-wrap; 
        }

        /* 搜尋樣式 */
        .search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.75rem;
            font-weight: 800;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.2s;
        }
        .search-input:focus { border-color: #3b82f6; }
        
        .search-results {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 2px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 0.75rem 0.75rem;
            display: none;
            z-index: 110;
        }
        .search-item {
            padding: 0.6rem 1rem;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 800;
            border-bottom: 1px solid #f1f5f9;
        }
        .search-item:hover { background-color: #eff6ff; }

        /* 卡片設計 */
        .card { 
            background: white; border-radius: 1rem; border: 1px solid #e2e8f0; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); padding: 2.25rem;
            display: flex;
            flex-direction: column;
            min-height: 280px; 
        }
        .law-box { border-top: 8px solid #3b82f6; }
        .white-box { border-top: 8px solid #10b981; }

        .section-teaching { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 1.5rem; 
        }

        /* 懲罰標籤 */
        .penalty-card-box { 
            border-top: 10px solid #f59e0b; 
            background: linear-gradient(to bottom, #fff, #fffbf0);
            padding: 1.5rem 2rem !important;
            min-height: auto;
        }
        .penalty-container {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            width: 100%;
        }
        .penalty-tag { 
            border-radius: 1.25rem; 
            padding: 1.25rem 2rem; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center;
            text-align: center;
            flex: 1;
            min-width: 280px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
            border: 2px solid transparent;
            transition: transform 0.2s;
        }
        .tag-money { background-color: #fefce8; color: #854d0e; border-color: #fde047; }
        .tag-jail { background-color: #fef2f2; color: #991b1b; border-color: #fecaca; }
        .tag-license { background-color: #eff6ff; color: #1e40af; border-color: #bfdbfe; }

        /* 按鈕與功能 */
        .btn-quiz-mini { 
            background-color: #ef4444; color: white; padding: 0.6rem 1.5rem; 
            border-radius: 9999px; font-weight: 900; font-size: 1.1rem;
            cursor: pointer; display: flex; align-items: center; gap: 0.5rem;
            transition: all 0.2s;
        }
        .btn-quiz-mini:hover { transform: scale(1.05); background-color: #dc2626; }

        #level-badge { 
            cursor: pointer; font-weight: 900; 
            padding: 0.6rem 1.5rem; border-radius: 9999px; font-size: 1.1rem;
            display: flex; align-items: center; gap: 0.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            transition: all 0.2s;
        }
        .badge-b1-b2 { background-color: #3b82f6 !important; color: white !important; }
        .badge-c1-c2 { background-color: #8b5cf6 !important; color: white !important; }

        .glossary-word {
			text-decoration: underline; 
			text-underline-offset: 4px;
			text-decoration-style: dashed; 
			cursor: pointer; 
			font-weight: 900;
			transition: opacity 0.2s;
		}
		.glossary-word:hover { opacity: 0.7; }

		/* 定義四種交替顏色 */
		.word-color-0 { color: #2563eb; } /* 藍 */
		.word-color-1 { color: #7c3aed; } /* 紫 */
		.word-color-2 { color: #0891b2; } /* 青 */
		.word-color-3 { color: #db2777; } /* 粉 */

        /* 側邊欄底部 */
        .sidebar-footer {
            margin-top: auto;
            padding-top: 1.5rem;
            border-top: 2px solid #e2e8f0;
        }
        .btn-footer {
            width: 100%;
            padding: 0.7rem;
            border-radius: 0.85rem;
            font-weight: 900;
            font-size: 0.9rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-log { background-color: #475569; color: white; }
        .btn-glossary { background-color: #3b82f6; color: white; }
        .btn-info { background-color: #0f172a; color: white; }

        .contact-info {
            font-size: 0.75rem;
            font-weight: 800;
            color: #64748b;
            line-height: 1.6;
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            margin-top: 0.5rem;
        }

        /* 詞彙庫獨立頁面 */
        .glossary-row {
            display: grid;
            grid-template-columns: 220px 150px 1fr;
            gap: 1.5rem;
            background: white;
            padding: 1.75rem 2.25rem;
            border-radius: 1.25rem;
            border: 1px solid #e2e8f0;
            margin-bottom: 1.25rem;
            align-items: center;
            transition: all 0.2s;
        }
        .glossary-row:hover { border-color: #3b82f6; transform: translateX(5px); box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.1); }
        .glossary-term-col { display: flex; flex-direction: column; }
        .glossary-def-col { font-weight: 800; color: #475569; line-height: 1.7; font-size: 1.1rem; }

        input[type="radio"] { display: none; }
        .option-label {
            cursor: pointer; padding: 1.25rem 2.25rem; border: 3px solid #e2e8f0; 
            border-radius: 1.25rem; transition: all 0.2s; display: block; 
            font-size: 1.25rem; font-weight: 900; margin-bottom: 0.85rem;
        }
        .option-label.selected-correct { background-color: #dcfce7; border-color: #10b981; color: #166534; }
        .option-label.selected-wrong { background-color: #fee2e2; border-color: #ef4444; color: #991b1b; }
    </style>
</head>
<body>

<canvas id="confetti-canvas" style="position:fixed; top:0; left:0; pointer-events:none; z-index:2000;"></canvas>

<!-- 詞彙單個解釋彈窗 -->
<div id="term-modal-overlay" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-md flex items-center justify-center z-[1100]" onclick="closeTermModal()">
    <div class="bg-white p-10 rounded-[2.5rem] max-w-md w-[90%] shadow-2xl" onclick="event.stopPropagation()">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h3 id="modal-term" class="text-3xl font-black text-blue-900">詞彙解釋</h3>
                <p id="modal-pinyin" class="text-sm text-slate-400 font-black tracking-widest uppercase mt-1">Pinyin</p>
                <div id="modal-en" class="text-[11px] font-black text-blue-700 italic mt-4 bg-blue-50 px-4 py-2 rounded-full w-fit border border-blue-100">English Context</div>
            </div>
            <button onclick="closeTermModal()" class="text-slate-300 hover:text-slate-600 text-4xl font-black">✕</button>
        </div>
        <div class="bg-slate-50 p-8 rounded-3xl border-2 border-slate-100 shadow-inner">
            <p id="modal-def" class="text-slate-700 text-lg font-black leading-relaxed"></p>
        </div>
    </div>
</div>

<!-- 測驗彈窗 -->
<div id="quiz-modal-overlay" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-md flex items-center justify-center z-[1100]" onclick="closeQuizModal()">
    <div class="bg-white p-12 rounded-[3rem] max-w-3xl w-[95%] shadow-2xl border-t-[14px] border-red-500" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-10">
            <h3 class="text-3xl font-black text-slate-800 flex items-center gap-4"><span>📝</span> 試試看！</h3>
            <button onclick="closeQuizModal()" class="text-slate-300 hover:text-slate-600 text-4xl font-black">✕</button>
        </div>
        <div class="bg-slate-50 p-10 rounded-[2.5rem] mb-4 border-2 border-slate-100 shadow-inner overflow-y-auto max-h-[60vh]">
            <p id="quiz-question" class="text-2xl font-black text-slate-700 mb-10 leading-tight"></p>
            <div id="options-container" class="grid grid-cols-1 gap-4"></div>
            <div id="feedback-box" class="mt-8 p-8 rounded-3xl hidden font-black text-xl text-center shadow-xl"></div>
        </div>
    </div>
</div>

<!-- 更新日誌彈窗 -->
<div id="log-modal-overlay" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-md flex items-center justify-center z-[1100]" onclick="closeLogModal()">
    <div class="bg-white p-12 rounded-[3rem] max-w-2xl w-[90%] shadow-2xl border-t-[12px] border-slate-600" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-8">
            <h3 class="text-3xl font-black text-slate-800 flex items-center gap-4"><span>📜</span> 系統更新日誌 (Log)</h3>
            <button onclick="closeLogModal()" class="text-slate-300 hover:text-slate-600 text-4xl font-black">✕</button>
        </div>
        <div class="bg-slate-50 p-10 rounded-[2.5rem] border shadow-inner max-h-[55vh] overflow-y-auto">
            <div class="space-y-10 text-sm font-bold text-slate-700">
                <div class="border-l-4 border-blue-500 pl-6">
                    <p class="text-blue-600 font-black text-lg mb-2">2026/01/14 (V0.e - Latest)</p>
                    <ul class="list-disc space-y-2 text-base">
						<li>更新「申請」等84個詞彙解釋</li>
						<li>調整了部分詞彙的英文翻譯</li>
						<li>新增「入出國及移民法#31」等2條法條相關內容</li>						
                    </ul>
                </div>
                <div class="border-l-4 border-emerald-500 pl-6">
                    <p class="text-emerald-600 font-black text-lg mb-2">2026/01/12 (V0.d)</p>
                    <ul class="list-disc space-y-2 text-base">
						<li>新增「核准」等52個詞彙解釋</li>
						<li>新增「入出國及移民法#23」等1條法條相關內容</li>		
                    </ul>
                </div>
				<div class="border-l-4 border-amber-500 pl-6">
                    <p class="text-amber-600 font-black text-lg mb-2">2026/01/08 (V0.C)</p>
                    <ul class="list-disc space-y-2 text-base">
                        <li>刪除了目前版本內尚未建置完成的法條及詞彙庫之佔位符</li>
						<li>(08:54-V0.C-1)新增「符合」等17個詞彙解釋</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 網站資訊與版權彈窗-->
<div id="info-modal-overlay" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-md flex items-center justify-center z-[1100]" onclick="closeInfoModal()">
    <div class="bg-white p-12 rounded-[3rem] max-w-2xl w-[90%] shadow-2xl border-t-[12px] border-blue-900" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-8">
            <h3 class="text-2xl font-black text-blue-900 flex items-center gap-4"><span>ℹ️</span> 網站資訊與版權聲明</h3>
            <button onclick="closeInfoModal()" class="text-slate-300 hover:text-slate-600 text-4xl font-black">✕</button>
        </div>
        <div class="bg-slate-50 p-10 rounded-[2.5rem] border shadow-inner max-h-[55vh] overflow-y-auto">
            <div class="space-y-10 text-base font-bold text-slate-700">
                <section>
                    <h4 class="text-xl font-black text-slate-800 mb-4 border-l-6 border-blue-500 pl-4 uppercase tracking-tighter">📜 網站資訊</h4>
                    <p class="leading-relaxed">
                        本站創立於 2026 年，旨在透過將專業術語依指定等級進行翻譯，協助外籍人士透過理解我國法律。</br>
						本站僅二人共同開發，更新頻率約為每月3次不定時更新，且僅更新與外籍人士相關之法條說明。如有針對特定法條的製作需求，請來信告知。
                    </p>
                </section>
                <section>
                    <h4 class="text-xl font-black text-slate-800 mb-4 border-l-6 border-blue-500 pl-4 uppercase tracking-tighter">⚖️ 版權聲明</h4>
                    <p class="leading-relaxed mb-4">
                        本站法條原文引自全國法規資料庫。解釋、引言、題目之著作權歸開發小組所有。</br>
						本站所有內容可供正常查詢、分享及教學使用，然禁止進行販售等金錢相關交易行為。
                    </p>
                    <div class="bg-red-50 p-6 rounded-3xl border-2 border-red-100 text-red-900 font-black">
                        ⚠️ 內容僅供華語學習參考。具體法律疑慮請諮詢律師。
                    </div>
                </section>
            </div>
        </div>
    </div>
</div>

<!-- 等級選擇彈窗 -->
<div id="level-modal-overlay" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-md flex items-center justify-center z-[1100]" onclick="closeLevelModal()">
    <div class="bg-white p-12 rounded-[3rem] max-w-sm w-[90%] shadow-2xl text-center" onclick="event.stopPropagation()">
        <h3 class="text-2xl font-black text-slate-800 mb-8 tracking-tight">更換學習程度 (Level)</h3>
        <div class="space-y-4">
            <div class="p-5 border-4 border-blue-500 bg-blue-50 rounded-2xl cursor-pointer flex items-center gap-4 transition-transform hover:scale-105" onclick="changeLevel('B1-B2')">
                <div class="w-5 h-5 rounded-full bg-blue-500"></div>
                <span class="font-black text-blue-800 text-lg">B1-B2 中級</span>
            </div>
            <div class="p-5 border-4 border-purple-500 bg-purple-50 rounded-2xl cursor-pointer flex items-center gap-4 transition-transform hover:scale-105" onclick="changeLevel('C1-C2')">
                <div class="w-5 h-5 rounded-full bg-purple-500"></div>
                <span class="font-black text-purple-800 text-lg">C1-C2 高級</span>
            </div>
        </div>
    </div>
</div>

<!-- 側邊欄 -->
<div class="sidebar shadow-2xl">
    <h2 class="text-2xl font-black text-slate-800 mb-6 tracking-tighter border-b-4 border-blue-100 pb-4 uppercase">📚 法律學習導航</h2>
    
    <div class="space-y-8 flex-1">
        <div>
            <label class="text-[14px] font-black text-slate-500 block mb-3 uppercase tracking-wider">🔍 單元搜尋 (Search Law)</label>
            <input type="text" id="article-search" class="search-input" placeholder="搜尋生活情境..." oninput="handleSearch()">
            <div id="search-results-list" class="search-results shadow-lg"></div>
        </div>

        <div>
            <label class="text-[14px] font-black text-slate-500 block mb-3 uppercase tracking-wider">1. 法典選擇 (Choose Law)</label>
            <select id="law-category-selector" class="w-full p-4 border-2 border-slate-300 rounded-2xl text-sm font-black bg-white outline-none focus:border-blue-500 shadow-sm" onchange="onCategoryChange()"></select>
        </div>
        <div>
            <label class="text-[14px] font-black text-slate-500 block mb-3 uppercase tracking-wider">2. 條文選擇 (Select Article)</label>
            <select id="article-selector" class="w-full p-4 border-2 border-slate-300 rounded-2xl text-sm font-black bg-white outline-none focus:border-blue-500 shadow-sm" onchange="updateContent()"></select>
        </div>
    </div>

    <div class="sidebar-footer">
        <div class="btn-footer btn-glossary" onclick="switchView('glossary')">📚 完整詞彙庫 (Glossary)</div>
        <div class="btn-footer btn-log" onclick="openLogModal()">📜 更新日誌 (Log)</div>
        <div class="btn-footer btn-info" onclick="openInfoModal()">ℹ️ 網站資訊與版權聲明</div>
        <div class="contact-info text-center font-black">
            📍 錯誤回報：guowenjiaocai@gmail.com
        </div>
    </div>
</div>

<!-- 學習主畫面 -->
<div id="view-study" class="main-content">
    <div class="sticky-header" id="main-header">
        <h1 class="text-3xl font-black text-slate-800 tracking-tight">📖 法條學習</h1>
        <div class="flex items-center gap-4">
            <div class="btn-quiz-mini" onclick="openQuizModal()"><span>📝</span> challenge</div>
            <div id="level-badge" onclick="openLevelModal()" class="badge-b1-b2 shadow-lg">
                <span id="badge-text">等級：B1-B2</span><span>▼</span>
            </div>
        </div>
    </div>
    <div id="intro-box" class="intro-quote">💡 生活提問載入中...</div>
    <div class="section-teaching">
        <div class="card law-box">
            <h3 class="sub-title italic text-blue-700">📜 法律條文原文 (Original)</h3>
            <p id="law-original" class="content-text text-slate-600 font-bold"></p>
        </div>
        <div class="card white-box">
            <h3 class="sub-title italic text-emerald-700">💡 法條說明 (Explanation)</h3>
            <p id="law-simplified" class="content-text font-black text-slate-900"></p>
        </div>
    </div>
    <div class="section-penalty">
        <div class="card penalty-card-box">
            <div id="penalty-grid" class="penalty-container"></div>
        </div>
    </div>
</div>

<!-- 詞彙庫獨立頁面 -->
<div id="view-glossary" class="main-content hidden">
    <div class="sticky-header border-b-2 pb-6 mb-8">
        <div>
            <h1 class="text-4xl font-black text-slate-800 tracking-tight">📖 詞彙庫 (Glossary)</h1>
            <p class="text-slate-500 font-bold mt-1 text-lg">專業術語解釋</p>
        </div>
        <button class="btn-quiz-mini bg-blue-600 border-none px-10 py-4" onclick="switchView('study')">⬅ 返回學習</button>
    </div>
    <div class="mb-10">
        <label class="text-[16px] font-black text-slate-500 block mb-3 uppercase tracking-wider">🔍 搜尋辭庫 (Search Terms)</label>
        <input type="text" id="glossary-search" class="search-input py-6 text-2xl border-4" placeholder="輸入關鍵字..." oninput="handleGlossarySearch()">
    </div>
    <div id="glossary-table-content" class="pb-20"></div>
</div>

<script>
    let currentLevel = "B1-B2";

    // 詞彙庫
    const globalGlossary = {
		"申請": { pinyin: "shēnqǐng", en: "apply", def: "向政府或機構正式提出要求。" },
		"居留證": { pinyin: "jūliú zhèng", en: "residence permit", def: "讓外國人可以在台灣合法住一段時間的證件。" },
		"外僑": { pinyin: "wàiqiáo", en: "foreign national", def: "住在台灣的外國人。" },
		"簽證": { pinyin: "qiānzhèng", en: "visa", def: "進入一個國家前需要的許可文件。" },
		"入境": { pinyin: "rùjìng", en: "entry", def: "進入一個國家。" },
		"合法": { pinyin: "héfǎ", en: "legal", def: "事情符合規定，是可以做的。" },
		"資格": { pinyin: "zīgé", en: "qualification / eligibility", def: "一個人有沒有權利做某件事。" },
		"移民署": { pinyin: "yímín shǔ", en: "National Immigration Agency", def: "政府管理外國人入境、居留的單位。" },
		"證件": { pinyin: "zhèngjiàn", en: "official document / ID", def: "可以證明身分或資格的文件。" },
		"功能": { pinyin: "gōngnéng", en: "function", def: "一個東西可以用來做什麼。" },
		"有效": { pinyin: "yǒuxiào", en: "valid", def: "在規定的時間內，可以使用。" },
		"停留": { pinyin: "tíngliú", en: "stay (short-term)", def: "在一個地方短時間待著，不是長住。" },
		"居留": { pinyin: "jūliú", en: "reside / residence", def: "在一個地方住一段比較長的時間。" },
		"許可": { pinyin: "xǔkě", en: "permission / permit", def: "政府或單位同意你做某件事。" },
		"翌日": { pinyin: "yìrì", en: "the next day", def: "今天的下一天。" },
		"逾": { pinyin: "yú", en: "exceed / over", def: "超過規定的時間或數量。" },
		"免": { pinyin: "miǎn", en: "be exempt from / not need to", def: "不用做某件事。" },
		"符合": { pinyin: "fúhé", en: "meet / comply with", def: "和要求一樣，沒有問題。" },
		"情況": { pinyin: "qíngkuàng", en: "situation / condition", def: "事情發生時的狀態或原因。" },
		"規定": { pinyin: "guīdìng", en: "regulation / rule", def: "政府或單位訂下的規則。" },
		"身分": { pinyin: "shēnfèn", en: "legal status / identity", def: "一個人在法律上的身份。" },
		"取得": { pinyin: "qǔdé", en: "obtain / acquire", def: "經過申請後得到。" },
		"配偶": { pinyin: "pèiǒu", en: "spouse", def: "法律上的另一伴。" },
		"子女": { pinyin: "zǐ nǚ", en: "children", def: "自己的孩子，包括兒子和女兒。" },
		"條件": { pinyin: "tiáojiàn", en: "condition / requirement", def: "一定要先做到的要求。" },
		"之後": { pinyin: "zhīhòu", en: "after / afterwards", def: "某一個時間點以後。" },
		"相同": { pinyin: "xiāngtóng", en: "same / identical", def: "兩個東西一樣，沒有差別。" },
		"並且": { pinyin: "bìngqiě", en: "and / also", def: "連接兩件同時發生的事情。" },
		"並": { pinyin: "bìng", en: "and / also", def: "連接兩件同時發生的事情。" },
		"限制": { pinyin: "xiànzhì", en: "restriction / limit", def: "有規則，不能自由做。" },
		"投資": { pinyin: "tóuzī", en: "investment", def: "把錢或資源用來做生意。" },
		"相關": { pinyin: "xiāngguān", en: "related / relevant", def: "和某件事情有關係。" },
		"特定": { pinyin: "tèdìng", en: "specific / designated", def: "指定的，不是全部。" },
		"經營": { pinyin: "jīngyíng", en: "operate / run (a business)", def: "管理和發展一個事業。" },
		"延期": { pinyin: "yánqí", en: "postpone / extend (time)", def: "時間往後推，不是現在。" },
		"核准": { pinyin: "hézhǔn", en: "approve", def: "政府看過後說可以。" },
		"使用": { pinyin: "shǐyòng", en: "use / using", def: "拿來用。" },
		"項": { pinyin: "xiàng", en: "item / clause", def: "條文或內容中的一個部分。" },
		"主管": { pinyin: "zhǔguǎn", en: "in charge", def: "負責管理的人或單位。" },
		"之": { pinyin: "zhī", en: "of (formal)", def: "表示「的」，多用在正式文件。" },
		"機關": { pinyin: "jīguān", en: "government agency", def: "政府的單位。" },
		"地區": { pinyin: "dìqū", en: "area / region", def: "一個地方或區域。" },
		"目前": { pinyin: "mùqián", en: "currently", def: "現在這個時間。" },
		"根據": { pinyin: "gēnjù", en: "according to / based on", def: "依照某個法律或資料。" },
		"及": { pinyin: "jí", en: "and", def: "連接前後兩個內容，表示「和」。" },
		"永久": { pinyin: "yǒngjiǔ", en: "permanent", def: "沒有時間限制，一直有效。" },
		"款": { pinyin: "kuǎn", en: "paragraph / sub-clause", def: "法律條文中的一小段。" },
		"戶籍": { pinyin: "hùjí", en: "household registration", def: "政府記錄的住家資料。" },
		"未滿": { pinyin: "wèimǎn", en: "under / not yet reached", def: "還不到某個年齡或時間。" },
		"人才": { pinyin: "réncái", en: "talent / skilled person", def: "有專業能力的人。" },
		"教學": { pinyin: "jiàoxué", en: "teaching", def: "教書和上課。" },
		"專業": { pinyin: "zhuānyè", en: "professional / expertise", def: "特別學過、很熟的能力。" },
		"原本": { pinyin: "yuánběn", en: "originally", def: "一開始就是這樣。" },
		"事業": { pinyin: "shìyè", en: "enterprise", def: "工作或公司。" },
		"與": { pinyin: "yǔ", en: "and / with", def: "表示「和」，比較正式。" },
		"從事": { pinyin: "cóngshì", en: "engage in", def: "做某一種工作或活動。" },
		"持續": { pinyin: "chíxù", en: "continue", def: "一直做，沒有停。" },
		"以免": { pinyin: "yǐmiǎn", en: "in order to avoid", def: "為了不要發生不好的事。" },
		"勞動": { pinyin: "láodòng", en: "labor / work", def: "工作、付出體力或時間。" },
		"國民": { pinyin: "guómín", en: "national", def: "一個國家的人民。" },
		"就業": { pinyin: "jiùyè", en: "employment", def: "有工作。" },
		"機構": { pinyin: "jīgòu", en: "institution / organization", def: "組織或單位。" },
		"行政": { pinyin: "xíngzhèng", en: "administrative", def: "政府的管理工作。" },
		"中央": { pinyin: "zhōngyāng", en: "central (government)", def: "國家層級，不是地方。" },
		"教育部": { pinyin: "jiàoyù bù", en: "Ministry of Education", def: "管理學校和教育的政府單位。" },
		"於": { pinyin: "yú", en: "at / in (formal)", def: "表示「在」或「於某時間」，很正式。" },
		"居住": { pinyin: "jūzhù", en: "live / reside", def: "住在某個地方。" },
		"註冊": { pinyin: "zhùcè", en: "register", def: "把資料登記在系統裡" },
		"持": { pinyin: "chí", en: "hold / possess", def: "拿著或擁有。" },
		"進行": { pinyin: "jìnxíng", en: "carry out / conduct", def: "正在做某件事。" },
		"就讀": { pinyin: "jiùdú", en: "be enrolled (in school)", def: "在學校念書。" },
		"確認": { pinyin: "quèrèn", en: "confirm", def: "再檢查一次，確定是真的。" },
		"認定": { pinyin: "rèndìng", en: "officially determine", def: "政府正式判定。" },
		"任意": { pinyin: "rènyì", en: "arbitrary / at will", def: "隨便、沒有規定。" },
		"原文": { pinyin: "yuánwén", en: "original text", def: "法律或文件原來的文字。" },
		"尊": { pinyin: "zūn", en: "respect (formal)", def: "表示尊敬，多用在正式用語。" },
		"認可": { pinyin: "rènkě", en: "recognize / approve", def: "正式同意、承認。" },
		"附設": { pinyin: "fùshè", en: "affiliated / attached", def: "另外加在一起的。" },
		"延攬": { pinyin: "yánlǎn", en: "recruit (talent)", def: "請專業的人來工作。" },
		"招收": { pinyin: "zhāoshōu", en: "admit / recruit", def: "學校或單位收學生或人員。" },
		"就業": { pinyin: "jiùyè", en: "employment", def: "有工作。" },
		"憑證": { pinyin: "píngzhèng", en: "certificate / credential", def: "用來證明身分或資格的文件。" },
		"親屬": { pinyin: "qīnshǔ", en: "relative / family member", def: "家人，如配偶、子女。" },
		"備註": { pinyin: "bèizhù", en: "note / remark", def: "補充說明的內容。" }
    };

    // 法規
    const studyData = [
        { 
            category: "入出國及移民法", 
            id: "imm_22", 
            name: "第 22 條 (入境後居留證)", 
            intro: "如果我想長時間留在台灣，需要辦什麼證件？", 
			original: `1. 外國人持有效簽證或適用以免簽證方式入國之有效護照或旅行證件，經移民署查驗許可入國後，取得停留、居留許可。
			
2. 依前項規定取得居留許可者，應於入國後之翌日起算三十日內，向移民署申請外僑居留證。但申請取得工作許可、居留簽證、外僑居留證及重入國許可四證合一之有效證件，或其他已含有外僑居留證功能之證件者，得免申請外僑居留證。

3. 外僑居留證之有效期間，自許可之翌日起算，最長不得逾三年。`,             
			levels: { 
                "B1-B2": { 
					simplified: `如果你有簽證，或是可以用免簽證的方式來台灣，在移民署同意後，你就可以合法地入境台灣，也可以在台灣停留或居留。
					
如果你已經有居留資格，你需要在入境後三十天內，到移民署申請外僑居留證。

如果你想要申請的證件也有居留證的功能，你不需要另外申請外僑居留證。

外僑居留證最多可以用三年。`,                    
					question: "入境後多久內要辦居留證？", 
                    options: ["30天內。", "90天內。"], 
                    answer: 0, 
                    feedback: "法律規定的時間是30天以內。" 
                },
                "C1-C2": { 
                    simplified: `外國人取得居留資格後，原則上應於三十日內申請居留證。

預計申請四證合一等有效證件者，得免於另外進行申請外僑居留證的申請。

居留證有效期限為三年。`, 
                    question: "甲是一名外國人，持有效居留簽證入境台灣，並經移民署查驗許可後取得居留資格。入境後第二十日，甲尚未向移民署申請外僑居留證，但甲已成功取得一張「四證合一」之有效證件，且該證件包含外僑居留證之功能。\n\n依本條規定，下列何者正確？", 
                    options: ["甲未於入境後三十日內申請外僑居留證，已違反規定", "甲因已持有包含外僑居留證功能之有效證件，得免再申請外僑居留證"], 
                    answer: 1, 
                    feedback: "本條規定，取得居留資格者，原則上須於入境翌日起三十日內申請外僑居留證；然而，若當事人已取得包含外僑居留證功能之有效證件，即屬例外情形，得免重複申請。因此，即使尚未另行申請外僑居留證，亦不構成違反規定。" 
                } 
            } 
        },
        { 
            category: "入出國及移民法", 
            id: "imm_23", 
            name: "第 23 條 (申請外僑居留證)", 
            intro: "如果我想申請外僑居留證，我需要符合哪些資格？", 
			original: `1. 持停留期限在六十日以上，且未經簽證核發機關加註限制不准延期或其他限制之有效簽證入國之外國人，有下列情形之一者，得向移民署申請居留，經許可者，核發外僑居留證：
			
一、配偶為現在在臺灣地區居住且設有戶籍或獲准居留之我國國民，或經核准居留或永久居留之外國人，或經核准居留之香港或澳門居民。但該經核准居留之配偶係依第九款或第十款規定經許可，或經中央勞動主管機關許可在我國從事就業服務法第四十六條第一項第八款至第十款工作者，不得申請。

二、未滿十八歲，其直系尊親屬為現在在臺灣地區設有戶籍或獲准居留之我國國民，或經核准居留或永久居留之外國人，或經核准居留之香港或澳門居民。其親屬關係因收養而發生者，被收養者應與收養者在臺灣地區共同居住。但該經核准居留之直系尊親屬係依第九款或第十款規定經許可，或經中央勞動主管機關許可在我國從事就業服務法第四十六條第一項第八款至第十款工作者，不得申請。

三、為現在在臺灣地區從事投資經營管理且已實行投資、跨國企業內部調動服務、學術科技研究或長期產業科技研究之大陸地區人民之配偶、未滿十八歲子女及年滿十八歲因身心障礙無法自理生活之子女。

四、經中央勞動主管機關或目的事業主管機關許可在我國從事就業服務法第四十六條第一項第一款至第七款、第十一款之工作或從事就業服務法第四十八條第一項第一款、第三款規定免經許可之工作，或從事外國專業人才延攬及僱用法第四條第四款第四目、第五目、第八條、第十條之專業工作，或依該法第十五條第一項取得工作許可。

五、在我國有一定金額以上之投資，經中央目的事業主管機關核准或備查之投資人或外國法人投資人之代表人。

六、外國公司在我國境內之負責人。

七、依前三款規定，經核准居留或永久居留者，其年滿十八歲因身心障礙無法自理生活之子女。

八、經僑務主管機關核轉各級主管教育行政機關分發之自行回國就學僑生。

九、配偶死亡時為居住臺灣地區設有戶籍國民，並對在臺灣地區已設有戶籍未成年子女，有撫育事實、行使負擔權利義務或會面交往。

十、曾為居住臺灣地區設有戶籍國民之配偶，且曾在我國合法居留，對在臺灣地區已設有戶籍未成年子女，有撫育事實、行使負擔權利義務或會面交往。

2. 以&zwnj;免簽證或持停留簽證入國之外國人，其符合前項第四款規定者，得向移民署申請居留，經許可者，核發外僑居留證。

3. 依前項規定經許可居留或持居留簽證入國經許可居留，且符合第一項第四款規定者，其配偶、未滿十八歲子女及年滿十八歲因身心障礙無法自理生活之子女，以免簽證或持停留簽證入國者，得向移民署申請居留，經許可者，核發外僑居留證。

4. 外國人申請居留原因與其原持憑入國之停留簽證目的相符，且有下列情形之一者，得向移民署申請居留，經許可者，核發外僑居留證：

一、經各級主管教育行政機關、大學或其組成之海外聯合招生委員會許可在我國就學之僑生。

二、經各級主管教育行政機關核定得招收外國學生之學校許可在我國就學之學生。

三、在教育部認可大專校院附設之華語教學機構就讀滿四個月，並繼續註冊三個月以上之學生。`, 
            levels: { 
                "B1-B2": { 
					simplified: `這一條是在說：如果你本來是來台灣停留，什麼情況下可以申請改成居留，並拿到外僑居留證。
			
如果你是外國人，拿著停留時間六十日以上的有效簽證入境，而且你的簽證上沒有寫不能延期或其他限制，在符合規定的情況下，就可以向移民署申請居留。

如果你申請居留的目的，是因為結婚或家庭關係、在台灣工作、投資或經營公司，或是來台灣讀書，只要你的身分符合規定，就有機會申請居留。不過，如果你的配偶或家人，是因某些特定工作身分取得居留，就不能用這一條來申請。

另外，如果你是用免簽證或停留簽證入境，只要之後取得在台灣工作的資格，也可以申請居留。已經取得居留身分的人，如果他的配偶或子女是用免簽或停留簽證入境，在符合條件的情況下，也可以一起申請居留。

最後，如果你申請居留的原因，和你一開始來台灣的目的相同，例如你是來台灣念書，而且也符合相關規定，也可以依這一條申請居留。`,                     
			question: "小明是外國人，持有停留期限六十日以上的有效簽證入境台灣，簽證上也沒有寫不能延期。他來台灣後，取得了在台灣工作的資格，想申請居留。\n\n根據本條規定，下列哪一個說法是正確的？", 
                    options: ["只要是停留簽證入境，就一定不能申請居留", "只要符合工作等規定，即使原本是停留身分，也可以申請居留"], 
                    answer: 1, 
                    feedback: "法律規定，只要持有符合條件的停留簽證，並因工作、家庭或就學等原因符合規定，就可以向移民署申請居留，不是只有一開始拿居留簽證的人才能申請。" 
                },
                "C1-C2": { 
                    simplified:`1. 外國人使用停留期限六十日以上的有效簽證入境，並且簽證沒有被備註不得延期或其他限制時，如果符合以下任意一項資格，就可以跟移民署申請居留。經過核准，核發外僑居留證：
					
（一）配偶是目前居住於臺灣地區並設有戶籍的台灣國民，或經過核准居留或永久居留的外國人。

（二）未滿十八歲，且直系尊親屬是目前在臺灣地區設有戶籍的台灣人，或經核准居留或永久居留之外國人。

（三）經過中央勞動主管機關或目的事業主管機關的許可，在台灣從事《就業服務法》認定的工作，或根據《外國專業人才延攬及僱用法》取得工作的人。

（四）其他：從原文進行確認。

2. 使用免簽證或停留簽證入境，而且符合前項第三款（工作許可）規定的外國人，可以向移民署申請居留；經過核准，核發外僑居留證。

3. 根據前項規定得到居留的允許，或使用居留簽證入境並經過核准居留，且符合第一項第三款規定的人，配偶及未滿十八歲的子女，如果以免簽證或持停留簽證入境，可以向移民署申請居留；經過核准，核發外僑居留證。

4. 外國人申請居留的原因，與原本使用憑證入境的停留簽證目的相同，且符合以下任一一種情形的人，可以向移民署申請居留；經過核准，核發外僑居留證：

（一）經過主管教育行政機關核准可以招收外國學生的學校，許可在台灣讀書的外國學生。

（二）在教育部認可的大專院校附設華語文教學機構就讀滿四個月，並持續註冊三個月以上之學生。`,  
                    question: "外國人以免簽證入境臺灣，並已取得合法工作許可。依本文規定，下列何者正確？", 
                    options: ["不得以免簽證身分申請居留。", "得向移民署申請居留。"], 
                    answer: 1, 
                    feedback: "法律明確規定，符合工作許可條件者，即使以免簽證入境，仍可申請居留，並非一定要先離境或更換簽證。" 
                } 
            } 
        },
        { 
            category: "入出國及移民法", 
            id: "imm_29", 
            name: "第 29 條 (居留時從事其他行為)", 
            intro: "我可以在台灣做和居留原因不同的事情嗎？", 
			original: `1. 外國人在我國停留、居留期間，不得從事與許可停留、居留原因不符之活動。但合法居留者，其請願及合法集會遊行，不在此限。
			
2. 任何人不得使外國人從事前項本文之活動。`, 
            levels: { 
                "B1-B2": { 
					simplified: `這條法律告訴我們，你在台灣停留或居留時，只可以做當初申請居留證時登記的事，不可以做和停留或居留目的不同的事情。不過，只要是合法居留，你還是可以請願、參加合法的集會和遊行。
					
另外，法律也規定，任何人都不能要求或安排外國人從事不符合其停留或居留原因的活動。`,                     
			question: "外國人在台灣居留期間，下列哪一個行為是不被允許的？", 
                    options: ["做和申請居留的原因沒有關係的事情。", "參加合法的集會。"], 
                    answer: 1, 
                    feedback: "外國人在台灣停留或居留期間，只能做當初申請停留或居留原因的事。如果做其他的事情，就可能違反規定。" 
                },
                "C1-C2": { 
                    simplified:`1. 外國人在台灣停留或居留的時候，只能做符合申請的停留或居留原因的活動，不可以做不相關的活動。但是，合法居留的外國人，可以參加依照法律進行得請願、集會或遊行。
					
2. 任何人都不可以安排或要求外國人參加前面禁止的活動。`,  
                    question: "外國人 Leo 因為「依親」在臺灣居留。在朋友的邀請下，他協助短期經營網路商店，負責商品上架與客服回覆。\n\n依照規定，下列判斷何者正確？", 
                    options: ["這可能被認為是和居留原因不同的行為。", "只要不是正式受僱，就一定不會違法。"], 
                    answer: 0, 
                    feedback: "是否構成違規，重點在活動內容是否和許可的居留原因相同，而不是是否具有正式受僱關係。" 
                } 
            } 
        },
        { 
            category: "入出國及移民法", 
            id: "imm_31", 
            name: "第 31 條 (外僑居留證延期資格和變更住址)", 
            intro: "我的居留證要到期了，我可以延長居留嗎？\n 💡 我搬家了，需要告訴政府嗎？", 
			original: `1. 外國人停留或居留期限屆滿前，有繼續停留或居留之必要時，應向移民署申請延期。
			
2.依前項規定申請居留延期經許可者，其外僑居留證之有效期間應自原居留屆滿之翌日起延期，最長不得逾三年。

3. 外國人逾期居留未滿三十日，原申請居留原因仍繼續存在者，經依第七十四條之一第二項規定處罰後，得向移民署重新申請居留；其申請永久居留者，核算在臺灣地區居留期間，應扣除一年。

4. 移民署對於外國人於居留期間內，居留原因消失者，廢止其居留許可，並註銷其外僑居留證。但有下列各款情形之一者，得准予繼續居留：

一、因依親對象死亡。

二、外國人為居住臺灣地區設有戶籍國民之配偶，因遭受家庭暴力離婚，且未再婚。

三、外國人於離婚後對在臺灣地區已設有戶籍未成年子女，有撫育事實、行使負擔權利義務或會面交往。

四、因居留許可被廢止而遭強制出國，對在臺灣地區已設有戶籍未成年子女造成重大且難以回復損害之虞。

五、外國人與本國雇主發生勞資爭議，正在進行爭訟程序。

六、外國人發生職業災害尚在治療中。

七、刑事案件之被害人、證人有協助偵查或審理之必要，經檢察官或法官認定其到庭或作證有助於案件之偵查或審理。

八、依第二十一條第一項規定禁止出國。

九、外國人以配偶為依親對象，取得居留許可，其依親對象為我國國民，於離婚後三十日內與原依親對象再婚。

5. 依前項第三款、第四款規定准予繼續居留者，其子女已成年，得准予繼續居留。

6. 外國人於居留期間，變更居留住址或服務處所時，應於事實發生之翌日起算三十日內，向移民署申請辦理變更登記。`, 
            levels: { 
                "B1-B2": { 
					simplified: `這條法律告訴我們，如果你可以停留或居留的時間要結束了，但你因為工作、家庭或其他合理的原因，需要繼續留在台灣，就一定要在結束以前，主動跟移民署申請延期，不可以等時間到了才處理。


如果你的申請通過了，你可以留在台灣的時間，會從原本結束的隔天開始延長，但延長的時間不可以超過三年。

如果你已經逾期居留，但時間還沒有超過30天，而且申請居留的原因仍然存在，在接受處罰後，你仍然可以向移民署重新申請居留。不過，如果之後你想要申請永久居留，你累積的住在台灣的時間，會減少一年。

相反，如果你在居留期間，原本申請的原因不存在了(例如離婚、離職)，你的外僑居留證會被註銷。但是，為了避免有些人遇到沒有辦法馬上處理的狀況，在特定狀況下，儘管申請的原因不存在了，還是可以繼續留在台灣，例如：依親對象過世、離婚後需要照顧留在台灣的未成年子女、因為工作受傷而在治療中等等。如果你是因為照顧子女所以留在台灣，即使未來子女成年了，還是可以繼續留在台灣。

另外，這條法律也提到，如果在居留期間，你的住址或工作地點不一樣了，必須在30天內去移民署申請資料變更。`,                     
			question: "外國人如果還需要繼續留在台灣，正確的做法是哪一個？", 
                    options: ["等居留期限過期之後，再向移民署說明原因。", "在居留期限到期之前，向移民署申請延期。"], 
                    answer: 1, 
                    feedback: "法律規定，如果外國人有繼續停留或居留的需要，必須在期限到期前就向移民署申請延期。" 
                },
                "C1-C2": { 
                    simplified:`1. 外國人在停留或居留期限到期之前，如果需要繼續停留或居留，應該跟移民署申請延期。

2. 依照前一項規定申請居留延期並且經過核准者，其外僑居留證的有效期間，應該自原居留期限屆滿的隔日起算，延期期間最長不得超過三年。

3. 外國人逾期居留未滿三十日，而且原本作為居留申請基礎的原因仍然存在的人，在依照第七十四條之一第二項規定接受處罰之後，可以向移民署重新申請居留；但是，如果未來申請永久居留，在計算已經在臺灣的居留時間時，會被扣除一年。

4. 移民署在外國人居留期間內，如果認定其居留原因已經消失，可以廢止其居留許可，並且註銷其外僑居留證。但是，符合下列情形之一者，仍然可以准許繼續居留：

（一）因為依親對象死亡。

（二）外國人為設有臺灣戶籍之我國國民的配偶，因為遭受家庭暴力而離婚，且未再婚。

（三）外國人在離婚之後，對在臺灣地區設有戶籍的未成年子女，實際負責撫養，並且行使或負擔權利義務，或進行會面與探視。


（四）如果被強制出國，對留在臺灣的未成年子女，可能造成重大且難以回復的損害的人。

（五）外國人與臺灣雇主之間發生爭議，且相關訴訟或爭議程序仍然在進行中。

（六）外國人發生職業災害，目前仍然在接受治療。

（七）外國人身分屬於刑事案件的被害人或證人，經檢察官或法官認定，其到庭或作證對案件的偵查或審理具有必要性。

（八）依照法律規定列為禁止出國對象。

（九）外國人以配偶身分取得居留許可，其依親對象為我國國民，並且在離婚後三十日內與原本的配偶再婚。

5. 依照前項第三款或第四款規定而准許繼續居留者，在子女成年後仍然可以繼續居留。

6. 外國人在居留期間，如果發生居留住址或工作地點的改變，應該在改變發生的隔日起三十日內，向移民署申請辦理變更登記。`,  
                    question: "Alex 的外僑居留證在 6 月 30 日到期，因為工作還沒有結束，他在 7 月 2 日向移民署提出延期申請。\n\n依照規定，下列判斷何者正確？", 
                    options: ["Alex 未在期限屆滿之前申請延期，已不符合延期申請的時點要求。", "Alex 的作法符合規定，只要提出申請即可。"], 
                    answer: 0, 
                    feedback: "延期申請應該在停留或居留期限到期之前提出，期限到期之後才申請，並不符合規定。" 
                } 
            } 
        },
    ];

    function initSelectors() {
        const catSelector = document.getElementById('law-category-selector');
        if(!catSelector) return;
        const laws = [...new Set(studyData.map(item => item.category))];
        catSelector.innerHTML = laws.map(law => `<option value="${law}">${law}</option>`).join('');
        onCategoryChange();
    }

    function onCategoryChange() {
        const lawName = document.getElementById('law-category-selector').value;
        const artSelector = document.getElementById('article-selector');
        const filtered = studyData.filter(item => item.category === lawName);
        artSelector.innerHTML = filtered.map(art => `<option value="${art.id}">${art.name}</option>`).join('');
        updateContent();
    }

    function handleSearch() {
        const query = document.getElementById('article-search').value.trim().toLowerCase();
        const resultList = document.getElementById('search-results-list');
        if (!query) { resultList.style.display = 'none'; return; }
        const matches = studyData.filter(item => item.intro.toLowerCase().includes(query) || item.name.toLowerCase().includes(query));
        if (matches.length > 0) {
            resultList.innerHTML = matches.map(item => `<div class="search-item" onclick="selectFromSearch('${item.category}', '${item.id}')">💡 ${item.intro}</div>`).join('');
            resultList.style.display = 'block';
        } else {
            resultList.innerHTML = '<div class="search-item text-slate-400">找不到相符法規</div>';
            resultList.style.display = 'block';
        }
    }

    function handleGlossarySearch() {
        const query = document.getElementById('glossary-search').value.trim().toLowerCase();
        renderGlossaryTable(query);
    }

    function selectFromSearch(category, id) {
        const catEl = document.getElementById('law-category-selector');
        const artEl = document.getElementById('article-selector');
        if(catEl && artEl) {
            catEl.value = category;
            onCategoryChange();
            artEl.value = id;
            updateContent();
        }
        document.getElementById('article-search').value = "";
        document.getElementById('search-results-list').style.display = 'none';
        switchView('study');
    }

    function updateContent() {
        const artId = document.getElementById('article-selector').value;
        const item = studyData.find(d => d.id === artId);
        if(!item) return;
        const content = item.levels[currentLevel];
        
        const bSpan = document.getElementById('badge-text');
        const lBadge = document.getElementById('level-badge');
        if (bSpan) bSpan.innerText = `等級：${currentLevel}`;
        if (lBadge) lBadge.className = `badge-${currentLevel.toLowerCase()} shadow-lg`;

        document.getElementById('intro-box').innerText = `💡 ${item.intro}`;
        document.getElementById('law-original').innerHTML = highlightTerms(item.original);
        document.getElementById('law-simplified').innerHTML = highlightTerms(content.simplified);
        
        const grid = document.getElementById('penalty-grid');
        grid.innerHTML = (item.penalties || []).map(p => {
            let colorClass = 'tag-license'; let icon = '🛡️'; let enLabel = '(Action)';
            if(p.type === 'money') { 
                colorClass = 'tag-money'; icon = '💰'; 
                enLabel = p.label.includes('罰金') ? '(Criminal Fine)' : '(Fine)';
            } else if(p.type === 'jail') { 
                colorClass = 'tag-jail'; icon = '⛓️'; enLabel = '(Imprisonment)'; 
            } else if(p.type === 'license') { 
                icon = (p.label.includes('離境') || p.label.includes('出國')) ? '✈️' : '🪪'; 
                enLabel = (p.label.includes('離境')) ? '(Deport)' : '(Suspension)';
            }
            return `<div class="penalty-tag ${colorClass}"><span class="text-[14px] font-black opacity-80 mb-2 uppercase tracking-wide">${icon} ${p.label} <span class="text-[10px] font-bold opacity-60">${enLabel}</span></span><span class="text-2xl font-black tracking-tighter">${p.value}</span></div>`;
        }).join('') || '<p class="text-slate-400 font-black italic">本單元無特定罰則</p>';
        
        document.getElementById('quiz-question').innerText = content.question;
        const container = document.getElementById('options-container');
        container.innerHTML = content.options.map((opt, idx) => `<div class="option-label" id="opt-label-${idx}" onclick="selectAnswer(${idx})">${opt}</div>`).join('');
        document.getElementById('feedback-box').style.display = 'none';
    }

    function selectAnswer(index) {
        const artId = document.getElementById('article-selector').value;
        const item = studyData.find(d => d.id === artId);
        const content = item.levels[currentLevel];
        const fb = document.getElementById('feedback-box');
        document.querySelectorAll('.option-label').forEach(el => el.classList.remove('selected-correct', 'selected-wrong'));
        const selectedLabel = document.getElementById(`opt-label-${index}`);
        fb.style.display = 'block';
        if (index === content.answer) {
            if(selectedLabel) selectedLabel.classList.add('selected-correct');
            fb.className = 'mt-8 p-8 rounded-3xl font-black text-xl text-left shadow-lg bg-emerald-100 text-emerald-800 border-2 border-emerald-500';
            fb.innerText = `✅ 正確！${content.feedback}`;
            startConfetti();
        } else {
            if(selectedLabel) selectedLabel.classList.add('selected-wrong');
            fb.className = 'mt-8 p-8 rounded-3xl font-black text-xl text-left shadow-lg bg-red-100 text-red-800 border-2 border-red-500';
            fb.innerText = `❌ 答錯了！${content.feedback}`;
        }
    }

    function switchView(viewName) {
        document.getElementById('view-study').classList.add('hidden');
        document.getElementById('view-glossary').classList.add('hidden');
        if (viewName === 'study') document.getElementById('view-study').classList.remove('hidden');
        else if (viewName === 'glossary') {
            document.getElementById('view-glossary').classList.remove('hidden');
            renderGlossaryTable();
        }
        window.scrollTo(0, 0);
    }

	function renderGlossaryTable(filterText = "") {
		const container = document.getElementById('glossary-table-content');
		if(!container) return;

		// 1. 取得 Key 並「按英文翻譯 (en) 首字母」排序
		// 我們抓取 globalGlossary 裡的 en 屬性進行比較
		let keys = Object.keys(globalGlossary).sort((a, b) => {
			const enA = globalGlossary[a].en.toLowerCase();
			const enB = globalGlossary[b].en.toLowerCase();
			return enA.localeCompare(enB);
		});
		
		// 2. 過濾邏輯 (支援中文、拼音、英文關鍵字搜尋)
		if (filterText) {
			const lowerFilter = filterText.toLowerCase();
			keys = keys.filter(key => 
				key.includes(filterText) || 
				globalGlossary[key].pinyin.toLowerCase().includes(lowerFilter) ||
				globalGlossary[key].en.toLowerCase().includes(lowerFilter)
			);
		}

		// 3. 如果找不到東西的提示
		if (keys.length === 0) { 
			container.innerHTML = '<p class="text-center text-slate-400 font-bold py-10 text-left">找不到相關詞彙</p>'; 
			return; 
		}

		// 4. 渲染 HTML
		container.innerHTML = keys.map(key => {
			const d = globalGlossary[key];
			return `
				<div class="glossary-row shadow-sm text-left">
					<div class="glossary-term-col">
						<span class="text-2xl font-black text-blue-900">${key}</span>
						<span class="text-xs text-slate-400 font-bold mt-1 tracking-widest uppercase">${d.pinyin}</span>
					</div>
					<div class="flex items-center">
						<span class="text-[10px] font-black text-blue-600 bg-blue-50 px-3 py-1 rounded-full border border-blue-100 italic">${d.en}</span>
					</div>
					<div class="glossary-def-col text-left text-base font-bold">${d.def}</div>
				</div>`;
		}).join('');
	}

    function highlightTerms(text) {
        if (!text) return "";
        const keys = Object.keys(globalGlossary).sort((a, b) => b.length - a.length);
        const pattern = new RegExp(keys.map(k => k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|'), 'g');
        
        let colorCounter = 0;
        const colorClasses = ['word-color-0', 'word-color-1', 'word-color-2', 'word-color-3'];
        const seenInThisBlock = new Set(); // 關鍵：記錄本區塊已出現的詞彙

        return text.replace(pattern, m => {
            // 如果這個詞已經出現過，就回傳原文字 (不加標籤)
            if (seenInThisBlock.has(m)) return m;
            
            // 第一次出現，記錄下來並上色
            seenInThisBlock.add(m);
            const cls = colorClasses[colorCounter % colorClasses.length];
            colorCounter++;
            return `<span class="glossary-word ${cls}" onclick="openTermModal('${m}')">${m}</span>`;
        });
    }

    function openTermModal(key) {
        const d = globalGlossary[key];
        document.getElementById('modal-term').innerText = key;
        document.getElementById('modal-pinyin').innerText = d.pinyin;
        document.getElementById('modal-en').innerText = d.en; 
        document.getElementById('modal-def').innerText = d.def;
        document.getElementById('term-modal-overlay').classList.remove('hidden');
    }

    function closeTermModal() { document.getElementById('term-modal-overlay').classList.add('hidden'); }
    function openQuizModal() { document.getElementById('quiz-modal-overlay').classList.remove('hidden'); }
    function closeQuizModal() { document.getElementById('quiz-modal-overlay').classList.add('hidden'); }
    function openLevelModal() { document.getElementById('level-modal-overlay').classList.remove('hidden'); }
    function closeLevelModal() { document.getElementById('level-modal-overlay').classList.add('hidden'); }
    function openLogModal() { document.getElementById('log-modal-overlay').classList.remove('hidden'); }
    function closeLogModal() { document.getElementById('log-modal-overlay').classList.add('hidden'); }
    function openInfoModal() { document.getElementById('info-modal-overlay').classList.remove('hidden'); }
    function closeInfoModal() { document.getElementById('info-modal-overlay').classList.add('hidden'); }
    function changeLevel(l) { currentLevel = l; updateContent(); closeLevelModal(); }

    function startConfetti() {
        const canvas = document.getElementById('confetti-canvas');
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let p = [];
        for (let i = 0; i < 40; i++) p.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height - canvas.height, r: Math.random() * 4 + 2, d: Math.random() * 10, c: `hsl(${Math.random() * 360}, 100%, 50%)`, t: Math.random() * 10 - 10 });
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            p.forEach((p) => {
                ctx.beginPath(); ctx.lineWidth = p.r; ctx.strokeStyle = p.c;
                ctx.moveTo(p.x + p.t + p.r / 2, p.y); ctx.lineTo(p.x + p.t, p.y + p.t + p.r / 2); ctx.stroke();
                p.y += 3; if (p.y > canvas.height) p.y = -20;
            });
        }
        let anim = setInterval(draw, 20);
        setTimeout(() => { clearInterval(anim); ctx.clearRect(0, 0, canvas.width, canvas.height); }, 2500);
    }
    

	
    window.onscroll = function() {
        const header = document.getElementById('main-header');
        if (header && window.pageYOffset > 10) header.classList.add('scrolled');
        else if (header) header.classList.remove('scrolled');
    };

    window.onload = () => { initSelectors(); };
</script>

</body>
</html>
